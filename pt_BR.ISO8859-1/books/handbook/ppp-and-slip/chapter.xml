<?xml version="1.0" encoding="iso-8859-1"?>
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter xmlns="http://docbook.org/ns/docbook"
  xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
  xml:id="ppp-and-slip">
  <!--
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Jim</firstname>
	<surname>Mock</surname>
	<contrib>Restructured, reorganized, and updated by in Mar 2000</contrib>
      </author>
    </authorgroup>
  </chapterinfo>
  -->

  <title><acronym>PPP</acronym></title>

  <sect1 xml:id="ppp-and-slip-synopsis">
    <title>Synopsis</title>

    <indexterm xml:id="ppp-ppp">
      <primary><acronym>PPP</acronym></primary>
    </indexterm>

    <para>&os; supports the Point-to-Point (<acronym>PPP</acronym>)
      protocol which can be used to establish a network or Internet
      connection using a dial-up modem.  This chapter describes how to
      configure modem-based communication services in &os;.</para>

    <para>After reading this chapter, you will know:</para>

    <itemizedlist>
      <listitem>
	<para>How to configure, use, and troubleshoot a
	  <acronym>PPP</acronym> connection.</para>
      </listitem>
      <listitem>
	<para>How to set up <acronym>PPP</acronym> over Ethernet
	  (<acronym>PPPoE</acronym>).</para>
      </listitem>
      <listitem>
	<para>How to set up <acronym>PPP</acronym> over
	  <acronym>ATM</acronym>
	  (<acronym>PPPoA</acronym>).</para>
      </listitem>
    </itemizedlist>

    <indexterm>
      <primary><acronym>PPP</acronym></primary>
    </indexterm>
    <indexterm>
      <primary><acronym>PPP</acronym></primary>
      <secondary>over Ethernet</secondary>
    </indexterm>

    <para>Before reading this chapter, you should:</para>

    <itemizedlist>
      <listitem>
	<para>Be familiar with basic network terminology.</para>
      </listitem>
      <listitem>
	<para>Understand the basics and purpose of a dial-up
	  connection and <acronym>PPP</acronym>.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="userppp">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Updated and enhanced by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Brian</firstname>
	  <surname>Somers</surname>
	  <contrib>Originally contributed by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Nik</firstname>
	  <surname>Clayton</surname>
	  <contrib>With input from </contrib>
	</author>
	<author>
	  <firstname>Dirk</firstname>
	  <surname>Fr&ouml;mberg</surname>
	</author>
	<author>
	  <firstname>Peter</firstname>
	  <surname>Childs</surname>
	</author>
      </authorgroup>
    </sect1info>
    -->

    <title>Configuring <acronym>PPP</acronym></title>

    <para>&os; provides built-in support for managing dial-up
      <acronym>PPP</acronym> connections using &man.ppp.8;.  The
      default &os; kernel provides support for
      <filename>tun</filename> which is used to interact with a
      modem hardware.  Configuration is performed by editing at least
      one configuration file, and configuration files containing
      examples are provided.  Finally, <command>ppp</command> is
      used to start and manage connections.</para>

    <para>In order to use a <acronym>PPP</acronym> connection, the
      following items are needed:</para>

    <itemizedlist>
      <listitem>
	<para>A dial-up account with an Internet Service Provider
	  (<acronym>ISP</acronym>).</para>
      </listitem>

      <listitem>
	<para>A dial-up modem.</para>
      </listitem>

      <listitem>
	<para>The dial-up number for the
	  <acronym>ISP</acronym>.</para>
      </listitem>

      <listitem>
	<para>The login name and password assigned by the
	  <acronym>ISP</acronym>.</para>
      </listitem>

      <listitem>
	<para>The <acronym>IP</acronym> address of one or more
	  <acronym>DNS</acronym> servers.  Normally, the
	  <acronym>ISP</acronym> provides these addresses.  If it did
	  not, &os; can be configured to use
	  <acronym>DNS</acronym> negotiation.</para>
      </listitem>
    </itemizedlist>

    <para>If any of the required information is missing, contact
      the <acronym>ISP</acronym>.</para>

    <para>The following information may be supplied by the
      <acronym>ISP</acronym>, but is not necessary:</para>

    <itemizedlist>
      <listitem>
	<para>The <acronym>IP</acronym> address of the default
	  gateway.  If this information is unknown, the
	  <acronym>ISP</acronym> will automatically provide the
	  correct value during connection setup.  When configuring
	  <acronym>PPP</acronym> on &os;, this address is referred to
	  as <literal>HISADDR</literal>.</para>
      </listitem>

      <listitem>
	<para>The subnet mask.  If the <acronym>ISP</acronym> has not
	  provided one, <systemitem
	    class="netmask">255.255.255.255</systemitem> will be used
	  in the &man.ppp.8; configuration file.</para>
      </listitem>

      <listitem>
	<indexterm xml:id="ppp-static-ip">
	  <primary>static <acronym>IP</acronym> address</primary>
	</indexterm>

	<para>If the <acronym>ISP</acronym> has assigned a static
	  <acronym>IP</acronym> address and hostname, it should be
	  input into the configuration file.  Otherwise, this
	  information will be automatically provided during
	  connection setup.</para>
      </listitem>
    </itemizedlist>

    <para>The rest of this section demonstrates how to configure &os;
      for common <acronym>PPP</acronym> connection scenarios.  The
      required configuration file is
      <filename>/etc/ppp/ppp.conf</filename> and additional files and
      examples are available in
      <filename>/usr/share/examples/ppp/</filename>.</para>

    <note>
      <para>Throughout this section, many of the file examples
	display line numbers.  These line numbers have been added to
	make it easier to follow the discussion and are not meant to
	be placed in the actual file.</para>

      <para>When editing a configuration file, proper indentation is
	important.  Lines that end in a <literal>:</literal> start in
	the first column (beginning of the line) while all other lines
	should be indented as shown using spaces or tabs.</para>
    </note>

    <sect2 xml:id="userppp-staticIP">
      <title>Basic Configuration</title>

      <indexterm>
	<primary>PPP</primary>
	  <secondary>with static <acronym>IP</acronym>
	    addresses</secondary>
      </indexterm>

      <para>In order to configure a <acronym>PPP</acronym> connection,
	first edit <filename>/etc/ppp/ppp.conf</filename> with the
	dial-in information for the <acronym>ISP</acronym>.  This file
	is described as follows:</para>

      <programlisting>1     default:
2       set log Phase Chat LCP IPCP CCP tun command
3       ident user-ppp VERSION
4       set device /dev/cuau0
5       set speed 115200
6       set dial "ABORT BUSY ABORT NO\\sCARRIER TIMEOUT 5 \
7                 \"\" AT OK-AT-OK ATE1Q0 OK \\dATDT\\T TIMEOUT 40 CONNECT"
8       set timeout 180
9       enable dns
10
11    provider:
12      set phone "(123) 456 7890"
13      set authname foo
14      set authkey bar
15      set timeout 300
16      set ifaddr <replaceable>x.x.x.x</replaceable>/0 <replaceable>y.y.y.y</replaceable>/0 255.255.255.255 0.0.0.0
17      add default HISADDR</programlisting>

	  <variablelist>
	    <varlistentry>
	      <term>Line 1:</term>

	      <listitem>
		<para>Identifies the <literal>default</literal> entry.
		  Commands in this entry (lines 2 through 9) are
		  executed automatically when <command>ppp</command>
		  is run.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 2:</term>

	      <listitem>
		<para>Enables verbose logging parameters for testing
		  the connection.  Once the configuration is working
		  satisfactorily, this line should be reduced
		  to:</para>

		  <programlisting>set log phase tun</programlisting>

	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 3:</term>

	      <listitem>
		<para>Displays the version of &man.ppp.8; to the
		  <acronym>PPP</acronym> software running on the other
		  side of the  connection.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 4:</term>

	      <listitem>
		<para>Identifies the device to which the modem is
		  connected, where  <filename>COM1</filename> is
		  <filename>/dev/cuau0</filename> and
		  <filename>COM2</filename> is
		  <filename>/dev/cuau1</filename>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 5:</term>

	      <listitem>
		<para>Sets the connection speed.  If
		  <literal>115200</literal> does not work on an older
		  modem, try <literal>38400</literal> instead.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Lines 6 &amp; 7:</term>

	      <listitem>
		<para>The dial string written as an expect-send
		  syntax.  Refer to &man.chat.8; for more
		  information.</para>

		<para>Note that this command continues onto the next
		  line for readability.  Any command in
		  <filename>ppp.conf</filename> may do this if the
		  last character on the line is
		  <literal>\</literal>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 8:</term>

	      <listitem>
		<para>Sets the idle timeout for the link in
		  seconds.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 9:</term>

	      <listitem>
		<para>Instructs the peer to confirm the
		  <acronym>DNS</acronym> settings.  If the local
		  network is running its own <acronym>DNS</acronym>
		  server, this line should be commented out, by adding
		  a <literal>#</literal> at the beginning of the line,
		  or removed.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 10:</term>

	      <listitem>
		<para>A blank line for readability.  Blank lines are
		  ignored by &man.ppp.8;.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 11:</term>

	      <listitem>
		<para>Identifies an entry called
		  <literal>provider</literal>.  This could be changed
		  to the name of the <acronym>ISP</acronym> so that
		  <option>load
		    <replaceable>ISP</replaceable></option> can be
		  used to start the connection.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 12:</term>

	      <listitem>
		<para>Use the phone number for the
		  <acronym>ISP</acronym>.  Multiple phone numbers may
		  be specified using the colon (<literal>:</literal>)
		  or pipe character (<literal>|</literal>) as a
		  separator.  To rotate through the numbers, use a
		  colon.  To always attempt to dial the first number
		  first and only use the other numbers if the first
		  number fails, use the pipe character.  Always
		  enclose the entire set of phone numbers between
		  quotation marks (<literal>"</literal>) to prevent
		  dialing failures.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Lines 13 &amp; 14:</term>

	      <listitem>
		<para>Use the user name and password for the
		  <acronym>ISP</acronym>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 15:</term>

	      <listitem>
		<para>Sets the default idle timeout in seconds for the
		  connection.  In this example, the connection will be
		  closed automatically after 300 seconds of
		  inactivity.  To prevent a timeout, set this value to
		  zero.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 16:</term>
	      <listitem>
		<para>Sets the interface addresses.  The values used
		  depend upon whether a static <acronym>IP</acronym>
		  address has been obtained from the
		  <acronym>ISP</acronym> or if it  instead negotiates
		  a dynamic <acronym>IP</acronym> address during
		  connection.</para>

		<para>If the  <acronym>ISP</acronym> has allocated a
		  static <acronym>IP</acronym> address and default
		  gateway, replace <replaceable>x.x.x.x</replaceable>
		  with the static  <acronym>IP</acronym> address and
		  replace <replaceable>y.y.y.y</replaceable> with the
		  <acronym>IP</acronym> address of the default
		  gateway.  If the <acronym>ISP</acronym> has only
		  provided a static <acronym>IP</acronym> address
		  without a gateway address, replace
		  <replaceable>y.y.y.y</replaceable> with <systemitem
		    class="netmask">10.0.0.2/0</systemitem>.</para>

		<para>If the <acronym>IP</acronym> address changes
		  whenever a connection is made, change this line to
		  the following value.  This tells &man.ppp.8; to use
		  the <acronym>IP</acronym> Configuration Protocol
		  (<acronym>IPCP</acronym>) to negotiate a dynamic
		  <acronym>IP</acronym> address:</para>

	  <programlisting>set ifaddr 10.0.0.1/0 10.0.0.2/0 255.255.255.255 0.0.0.0</programlisting>

	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 17:</term>

	      <listitem>
		<para>Keep this line as-is as it adds a default route
		  to the gateway.  The <literal>HISADDR</literal> will
		  automatically be replaced with the gateway address
		  specified on line 16.  It is important that this
		  line appears after line 16.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>

	  <para>Depending upon whether &man.ppp.8; is started
	    manually or automatically, a
	    <filename>/etc/ppp/ppp.linkup</filename> may also need to
	    be created which contains the following lines.  This file
	    is required when running <command>ppp</command> in
	    <option>-auto</option> mode.  This file is used after the
	    connection has been established.  At this point, the
	    <acronym>IP</acronym> address will have been assigned and
	    it is now be possible to add the routing table entries.
	    When creating this file, make sure that
	    <replaceable>provider</replaceable> matches the value
	    demonstrated in line 11 of
	    <filename>ppp.conf</filename>.</para>

	  <programlisting>provider:
      add default HISADDR</programlisting>

	<para>This file is also needed when the default gateway
	  address is <quote>guessed</quote> in a static
	  <acronym>IP</acronym> address configuration.  In this case,
	  remove line 17 from <filename>ppp.conf</filename> and
	  create <filename>/etc/ppp/ppp.linkup</filename> with the
	  above two lines.  More examples for this file can be found
	  in <filename>/usr/share/examples/ppp/</filename>.</para>

	<para>By default, <command>ppp</command> must be
	  run as <systemitem class="username">root</systemitem>.
	  To change this default, add the account of the user
	  who should run <command>ppp</command> to the <systemitem
	    class="groupname">network</systemitem> group in
	  <filename>/etc/group</filename>.</para>

	<para>Then, give the user access to one or more entries in
	  <filename>/etc/ppp/ppp.conf</filename> with
	  <command>allow</command>.  For example, to give
	  <systemitem class="username">fred</systemitem> and
	  <systemitem class="username">mary</systemitem>
	  permission to only the <literal>provider:</literal> entry,
	  add this line to the <literal>provider:</literal>
	  section:</para>

	<programlisting>allow users <replaceable>fred mary</replaceable></programlisting>

	<para>To give the specified users access to all entries, put
	  that line in the <literal>default</literal> section
	  instead.</para>
      </sect2>

    <?ignore <sect2>
	  <title>Receiving Incoming Calls</title>

	  <indexterm>
	    <primary><acronym>PPP</acronym></primary>
	    <secondary>receiving incoming calls</secondary>
	  </indexterm>

	  <para>When configuring &man.ppp.8; to receive incoming calls
	    on a machine connected to a Local Area Network
	    (<acronym>LAN</acronym>), decide if packets should be
	    forwarded to the <acronym>LAN</acronym>.  If so, allocate
	    the connecting system an <acronym>IP</acronym> address
	    from the <acronym>LAN</acronym>'s subnet, and add the
	    <command>enable proxy</command> line to
	    <filename>/etc/ppp/ppp.conf</filename>.
	    Also, confirm that <filename>/etc/rc.conf</filename>
	    contains the following line:</para>

	  <programlisting>gateway_enable="YES"</programlisting>

	  <para>Refer to &man.ppp.8; and
	    <filename>/usr/share/examples/ppp/ppp.conf.sample</filename>
	    for more details.  The following steps will also be
	    required:</para>

	  <procedure>
	    <step>
	      <para>Create an entry in
		<filename>/etc/passwd</filename> (using the
		&man.vipw.8; program).</para>
	    </step>

	    <step>
	      <para>Create a profile in this users home directory that
		runs <command>ppp -direct direct-server</command> or
		similar.</para>
	    </step>

	    <step>
	      <para>Create an entry in
		<filename>/etc/ppp/ppp.conf</filename>.  The
		<filename>direct-server</filename> example should
		suffice.</para>
	    </step>

	    <step>
	      <para>Create an entry in
		<filename>/etc/ppp/ppp.linkup</filename>.</para>
	    </step>
	  </procedure>
	</sect2>

	  <title><acronym>PPP</acronym> Shells for Dynamic
	    <acronym>IP</acronym> Users</title>

	  <indexterm>
	    <primary><acronym>PPP</acronym> shells</primary>
	  </indexterm>

	  <para>Create a file called
	    <filename>/etc/ppp/ppp-shell</filename> containing the
	    following:</para>

	  <programlisting>#!/bin/sh
IDENT=`echo $0 | sed -e 's/^.*-\(.*\)$/\1/'`
CALLEDAS="$IDENT"
TTY=`tty`

if [ x$IDENT = xdialup ]; then
        IDENT=`basename $TTY`
fi

echo "PPP for $CALLEDAS on $TTY"
echo "Starting PPP for $IDENT"

exec /usr/sbin/ppp -direct $IDENT</programlisting>

	  <para>This script should be executable.  Now make a
	    symbolic link called <filename>ppp-dialup</filename> to
	    this script using the following commands:</para>

	  <screen>&prompt.root; <userinput>ln -s ppp-shell /etc/ppp/ppp-dialup</userinput></screen>

	  <para>Use this script as the
	    <emphasis>shell</emphasis> for all of dial-up users.  This
	    is an example from <filename>/etc/passwd</filename> for a
	    dial-up <acronym>PPP</acronym>:</para>

	    <programlisting>pchilds:*:1011:300:Peter Childs PPP:/home/ppp:/etc/ppp/ppp-dialup</programlisting>

	    <para>Create a <filename
		>/home/ppp</filename> directory that
	      is world readable containing the following 0 byte
	      files:</para>

	    <screen>-r--r--r--   1 root     wheel           0 May 27 02:23 .hushlogin
-r--r--r--   1 root     wheel           0 May 27 02:22 .rhosts</screen>

	    <para>which prevents <filename>/etc/motd</filename> from
	      being displayed.</para>
	  </sect2>
	  <sect2>
	    <title><acronym>PPP</acronym> Shells for Static
	      <acronym>IP</acronym> Users</title>

	    <indexterm>
	      <primary><acronym>PPP</acronym> shells</primary>
	    </indexterm>

	    <para>Create <filename>ppp-shell</filename> as
	      above, and for each account with statically assigned
	      <acronym>IP</acronym>s create a symbolic link to
	      <filename>ppp-shell</filename>.</para>

	    <para>For example, to route /24 CIDR networks for the
	      dial-up customers <username>fred</username>,
	      <username>sam</username>, and
	      <username>mary</username>, type:</para>

	    <screen>&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-fred</userinput>
&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-sam</userinput>
&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-mary</userinput></screen>

	    <para>Each of these users dial-up accounts should have
	      their shell set to the symbolic link created above (for
	      example, <username>mary</username>'s shell should be
	      <filename>/etc/ppp/ppp-mary</filename>).</para>
	  </sect2>

	  <sect2>
	    <title>Setting Up <filename>ppp.conf</filename> for
	      Dynamic <acronym>IP</acronym> Users</title>

	    <para>Ensure that <filename>/etc/ppp/ppp.conf</filename>
	      contains something along the lines of:</para>

	    <programlisting>default:
  set debug phase lcp chat
  set timeout 0

ttyu0:
  set ifaddr 203.14.100.1 203.14.100.20 255.255.255.255
  enable proxy

ttyu1:
  set ifaddr 203.14.100.1 203.14.100.21 255.255.255.255
  enable proxy</programlisting>

	    <note>
	      <para>The indenting is important.</para>
	    </note>

	    <para>The <literal>default:</literal> section is loaded
	      for each session.  For each dial-up line enabled in
	      <filename>/etc/ttys</filename> create an entry similar
	      to the one for <literal>ttyu0:</literal> above.  Each
	      line should get a unique <acronym>IP</acronym> address
	      from the pool of <acronym>IP</acronym> addresses for
	      dynamic users.</para>
	  </sect2>

	  <sect2>
	    <title>Setting Up <filename>ppp.conf</filename> for
	      Static <acronym>IP</acronym> Users</title>

	    <para>Along with the contents of the sample
	      <filename>/usr/share/examples/ppp/ppp.conf</filename>
	      above, add a section for each of the statically assigned
	      dial-up users:.</para>

	    <programlisting>fred:
  set ifaddr 203.14.100.1 203.14.101.1 255.255.255.255

sam:
  set ifaddr 203.14.100.1 203.14.102.1 255.255.255.255

mary:
  set ifaddr 203.14.100.1 203.14.103.1 255.255.255.255</programlisting>

	    <para>The file <filename>/etc/ppp/ppp.linkup</filename>
	      should also contain routing information for each static
	      <acronym>IP</acronym> user if required.  The line below
	      would add a route for the <hostid
		role="ipaddr">203.14.101.0/24</hostid> network via the
	      client's ppp link.</para>

	    <programlisting>fred:
  add 203.14.101.0 netmask 255.255.255.0 HISADDR

sam:
  add 203.14.102.0 netmask 255.255.255.0 HISADDR

mary:
  add 203.14.103.0 netmask 255.255.255.0 HISADDR</programlisting>
	</sect2>
	?>

	<sect2>
	  <title>Advanced Configuration</title>

	  <indexterm>
	    <primary>DNS</primary>
	  </indexterm>

	  <indexterm>
	    <primary>NetBIOS</primary>
	  </indexterm>

	  <indexterm>
	    <primary><acronym>PPP</acronym></primary>
	    <secondary>Microsoft extensions</secondary>
	  </indexterm>

	  <para>It is possible to configure PPP to supply DNS and
	    NetBIOS nameserver addresses on demand.</para>

	  <para>To enable these extensions with
	    <acronym>PPP</acronym> version 1.x, the following lines
	    might be added to the relevant section of
	    <filename>/etc/ppp/ppp.conf</filename>.</para>

	  <programlisting>enable msext
set ns 203.14.100.1 203.14.100.2
set nbns 203.14.100.5</programlisting>

	  <para>And for <acronym>PPP</acronym> version 2 and
	    above:</para>

	  <programlisting>accept dns
set dns 203.14.100.1 203.14.100.2
set nbns 203.14.100.5</programlisting>

	  <para>This will tell the clients the primary and secondary
	    name server addresses, and a NetBIOS nameserver
	    host.</para>

	  <para>In version 2 and above, if the <literal>set
	      dns</literal> line is omitted,
	    <acronym>PPP</acronym> will use the values found in
	    <filename>/etc/resolv.conf</filename>.</para>

	<sect3 xml:id="userppp-PAPnCHAP">
	  <title>PAP and CHAP Authentication</title>

	  <indexterm><primary>PAP</primary></indexterm>
	  <indexterm><primary>CHAP</primary></indexterm>
	  <para>Some <acronym>ISP</acronym>s set their system up so
	    that the authentication part of the connection is done
	    using either of the PAP or CHAP authentication mechanisms.
	    If this is the case, the <acronym>ISP</acronym> will not
	    give a <prompt>login:</prompt> prompt at connection, but
	    will start talking <acronym>PPP</acronym>
	    immediately.</para>

	  <para>PAP is less secure than CHAP, but security is not
	    normally an issue here as passwords, although being sent
	    as plain text with PAP, are being transmitted down a
	    serial line only.  There is not much room for crackers
	    to <quote>eavesdrop</quote>.</para>

	  <para>The following
	    alterations must be made:</para>

	  <programlisting>13      set authname <replaceable>MyUserName</replaceable>
14      set authkey <replaceable>MyPassword</replaceable>
15      set login</programlisting>

	  <variablelist>
	    <varlistentry>
	      <term>Line 13:</term>

	      <listitem>
		<para>This line specifies the PAP/CHAP user name.
		  Insert the correct value for
		  <replaceable>MyUserName</replaceable>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 14:</term>
	      <listitem>
		<para>This line specifies the PAP/CHAP
		  password<indexterm><primary>password</primary></indexterm>.
		  Insert the correct value for
		  <replaceable>MyPassword</replaceable>.  You may
		  want to add an additional line, such as:</para>

		<programlisting>16      accept PAP</programlisting>

		<para>or</para>

		<programlisting>16      accept CHAP</programlisting>

		<para>to make it obvious that this is the intention,
		  but PAP and CHAP are both accepted by
		  default.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 15:</term>

	      <listitem>
		<para>The <acronym>ISP</acronym> will not normally
		  require a login to the server when using PAP or
		  CHAP.  Therefore, disable the <quote>set
		    login</quote> string.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</sect3>

      <sect3 xml:id="userppp-nat">
	<title>Using <acronym>PPP</acronym> Network Address
	  Translation Capability</title>

	<indexterm>
	  <primary><acronym>PPP</acronym></primary><secondary>NAT</secondary>
	</indexterm>

	<para>PPP has ability to use internal NAT without kernel
	  diverting capabilities.  This functionality may be enabled
	  by the following line in
	  <filename>/etc/ppp/ppp.conf</filename>:</para>

	<programlisting>nat enable yes</programlisting>

	<para>Alternatively, NAT may be enabled by command-line
	  option <literal>-nat</literal>.  There is also
	  <filename>/etc/rc.conf</filename> knob named
	  <literal>ppp_nat</literal>, which is enabled by
	  default.</para>

	<para>When using this feature, it may be useful to include
	  the following <filename>/etc/ppp/ppp.conf</filename> options
	  to enable incoming connections forwarding:</para>

	<programlisting>nat port tcp 10.0.0.2:ftp ftp
nat port tcp 10.0.0.2:http http</programlisting>

	<para>or do not trust the outside at all</para>

	<programlisting>nat deny_incoming yes</programlisting>
      </sect3>
      </sect2>

      <sect2 xml:id="userppp-final">
	<title>Final System Configuration</title>

	<indexterm>
	  <primary><acronym>PPP</acronym></primary><secondary>configuration</secondary>
	</indexterm>

	<para>While <command>ppp</command> is now configured,
	  some edits still need to be made to
	  <filename>/etc/rc.conf</filename>.</para>

	<para>Working from the top down in this file, make sure the
	  <literal>hostname=</literal> line is set:</para>

	<programlisting>hostname="foo.example.com"</programlisting>

	<para>If the <acronym>ISP</acronym> has supplied a static
	  <acronym>IP</acronym> address and name, use this name as the
	  host name.</para>

	<para>Look for the <literal>network_interfaces</literal>
	  variable.  To configure the system to dial the
	  <acronym>ISP</acronym> on demand, make sure the
	  <filename>tun0</filename> device is added to the list,
	  otherwise remove it.</para>

	<programlisting>network_interfaces="lo0 tun0"
ifconfig_tun0=</programlisting>

	<note>
	  <para>The <literal>ifconfig_tun0</literal> variable should
	    be empty, and a file called
	    <filename>/etc/start_if.tun0</filename> should be created.
	    This file should contain the line:</para>

	  <programlisting>ppp -auto mysystem</programlisting>

	  <para>This script is executed at network configuration time,
	    starting the ppp daemon in automatic mode.  If this
	    machine acts as a gateway, consider including
	    <option>-alias</option>.  Refer to the manual page for
	    further details.</para>
	</note>

	<para>Make sure that the router program is set to
	  <literal>NO</literal> with the following line in
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting>router_enable="NO"</programlisting>

	<indexterm>
	  <primary><application>routed</application></primary>
	</indexterm>

	<para>It is important that the <command>routed</command>
	  daemon is not started, as <command>routed</command> tends
	  to delete the default routing table entries created by
	  <command>ppp</command>.</para>

	<para>It is probably a good idea to ensure that the
	  <literal>sendmail_flags</literal> line does not include the
	  <option>-q</option> option, otherwise
	  <command>sendmail</command> will attempt to do a network
	  lookup every now and then, possibly causing your machine
	  to dial out.  You may try:</para>

	<programlisting>sendmail_flags="-bd"</programlisting>

	<indexterm>
	  <primary><application>sendmail</application></primary>
	</indexterm>
	<para>The downside is that <command>sendmail</command> is
	  forced to re-examine the mail queue whenever the ppp link.
	  To automate this, include <command>!bg</command> in
	  <filename>ppp.linkup</filename>:</para>

	<programlisting>1     provider:
2       delete ALL
3       add 0 0 HISADDR
4       !bg sendmail -bd -q30m</programlisting>

	<indexterm>
	  <primary>SMTP</primary>
	</indexterm>

	<para>An alternative is to set up a
	  <quote>dfilter</quote> to block SMTP traffic.  Refer to the
	  sample files for further details.</para>
      </sect2>

      <sect2>
	<title>Using <command>ppp</command></title>

	<para>All that is left is to reboot the machine.  After
	  rebooting, either type:</para>

	<screen>&prompt.root; <userinput>ppp</userinput></screen>

	<para>and then <command>dial provider</command> to start the
	  <acronym>PPP</acronym> session, or, to configure
	  <command>ppp</command> to establish sessions automatically
	  when there is outbound traffic and
	  <filename>start_if.tun0</filename> does not exist,
	  type:</para>

      <screen>&prompt.root; <userinput>ppp -auto provider</userinput></screen>

	  <para>It is possible to talk to the <command>ppp</command>
	    program while it is running in the background, but only
	    if a suitable diagnostic port has been set up.  To do
	    this, add the following line to the configuration:</para>

	  <programlisting>set server /var/run/ppp-tun<replaceable>%d</replaceable> DiagnosticPassword 0177</programlisting>

	<para>This will tell PPP to listen to the specified
	  &unix; domain socket, asking clients for the specified
	  password before allowing access.  The
	  <literal>%d</literal> in the name is replaced with the
	  <filename>tun</filename> device number that is in
	  use.</para>

	<para>Once a socket has been set up, the &man.pppctl.8;
	  program may be used in scripts that wish to manipulate
	  the running program.</para>
      </sect2>

	<sect2 xml:id="userppp-mgetty">
	  <title>Configuring Dial-in Services</title>

	  <indexterm>
	    <primary><command>mgetty</command></primary>
	  </indexterm>

	  <indexterm>
	    <primary>AutoPPP</primary>
	  </indexterm>

	  <indexterm>
	    <primary>LCP</primary>
	  </indexterm>
	  <para><xref linkend="dialup"/> provides a good description
	    on enabling dial-up services using &man.getty.8;.</para>

	  <para>An alternative to <command>getty</command> is
	    <package>comms/mgetty+sendfax</package>
	    port), a smarter version of <command>getty</command>
	    designed with dial-up lines in mind.</para>

	  <para>The advantages of using <command>mgetty</command> is
	    that it actively <emphasis>talks</emphasis> to modems,
	    meaning if port is turned off in
	    <filename>/etc/ttys</filename> then the modem will not
	    answer the phone.</para>

	  <para>Later versions of <command>mgetty</command> (from
	    0.99beta onwards) also support the automatic detection of
	    <acronym>PPP</acronym> streams, allowing clients
	    scriptless access to the server.</para>

	  <para>Refer to <link
	      xlink:href="http://mgetty.greenie.net/doc/mgetty_toc.html">http://mgetty.greenie.net/doc/mgetty_toc.html</link>
	    for more information on <command>mgetty</command>.</para>

	  <para>By default the <package>comms/mgetty+sendfax</package>
	    port comes with the <literal>AUTO_PPP</literal> option
	    enabled allowing <command>mgetty</command> to detect the
	    LCP phase of <acronym>PPP</acronym> connections and
	    automatically spawn off a ppp shell.  However, since the
	    default login/password sequence does not occur it is
	    necessary to authenticate users using either PAP or
	    CHAP.</para>

	  <para>This section assumes the user has successfully
	    compiled, and installed the
	    <package>comms/mgetty+sendfax</package> port on his
	    system.</para>

	  <para>Ensure that
	    <filename>/usr/local/etc/mgetty+sendfax/login.config</filename>
	    has the following:</para>

	  <programlisting>/AutoPPP/ -     - /etc/ppp/ppp-pap-dialup</programlisting>

	  <para>This tells <command>mgetty</command> to run
	    <filename>ppp-pap-dialup</filename> for detected
	    <acronym>PPP</acronym> connections.</para>

	  <para>Create an executable file called
	    <filename>/etc/ppp/ppp-pap-dialup</filename> containing
	    the following:</para>

	  <programlisting>#!/bin/sh
exec /usr/sbin/ppp -direct pap$IDENT</programlisting>

	  <para>For each dial-up line enabled in
	    <filename>/etc/ttys</filename>, create a corresponding
	    entry in <filename>/etc/ppp/ppp.conf</filename>.  This
	    will happily co-exist with the definitions we created
	    above.</para>

	  <programlisting>pap:
  enable pap
  set ifaddr 203.14.100.1 203.14.100.20-203.14.100.40
  enable proxy</programlisting>

	  <para>Each user logging in with this method will need to
	    have a username/password in
	    <filename>/etc/ppp/ppp.secret</filename>, or
	    alternatively add the following option to authenticate
	    users via PAP from
	    <filename>/etc/passwd</filename>.</para>

	  <programlisting>enable passwdauth</programlisting>

	  <para>To assign some users a static <acronym>IP</acronym>
	    number, specify the number as the third argument in
	    <filename>/etc/ppp/ppp.secret</filename>.  See
	    <filename>/usr/share/examples/ppp/ppp.secret.sample</filename>
	    for examples.</para>
	</sect2>
  </sect1>

  <sect1 xml:id="ppp-troubleshoot">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Contributed by in June 2003</contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>Troubleshooting <acronym>PPP</acronym> Connections</title>

    <indexterm>
      <primary><acronym>PPP</acronym></primary>
      <secondary>troubleshooting</secondary>
    </indexterm>

    <para>This section covers a few issues which may arise when
      using <acronym>PPP</acronym> over a modem connection.  Some
      <acronym>ISP</acronym>s present the
      <literal>ssword</literal> prompt while others present
      <literal>password</literal>.  If the <command>ppp</command>
      script is not written accordingly, the login attempt will
      fail.  The most common way to debug <command>ppp</command>
      connections is by connecting manually as described in this
      section.</para>

    <sect2>
      <title>Check the Device Nodes</title>

      <para>When using a custom kernel, make sure to include the
	following line in the kernel configuration file:</para>

      <programlisting>device   uart</programlisting>

      <para>The <filename>uart</filename> device is already
	included in the <literal>GENERIC</literal> kernel, so no
	additional steps are necessary in this case.  Just
	check the <command>dmesg</command> output for the modem
	device with:</para>

      <screen>&prompt.root; <userinput>dmesg | grep uart</userinput></screen>

      <para>This should display some pertinent output about the
	<filename>uart</filename> devices.  These are the COM
	ports we need.  If the modem acts like a standard serial port,
	it should be listed on <filename>uart1</filename>, or
	<filename>COM2</filename>.  If so, a kernel rebuild is not
	required.  When matching up, if the modem is on
	<filename>uart1</filename>, the modem device would be
	<filename>/dev/cuau1</filename>.</para>
    </sect2>

    <sect2>
      <title>Connecting Manually</title>

      <para>Connecting to the Internet by manually controlling
	<command>ppp</command> is quick, easy, and a great way to
	debug a connection or just get information on how the
	<acronym>ISP</acronym> treats <command>ppp</command> client
	connections.  Lets start <application>PPP</application> from
	the command line.  Note that in all of our examples we will
	use <emphasis>example</emphasis> as the hostname of the
	machine running <application>PPP</application>.  To start
	<command>ppp</command>:</para>

      <screen>&prompt.root; <userinput>ppp</userinput></screen>

      <screen>ppp ON example&gt; <userinput>set device /dev/cuau1</userinput></screen>

      <para>This second command sets the modem device to
	<filename>cuau1</filename>.</para>

      <screen>ppp ON example&gt; <userinput>set speed 115200</userinput></screen>

      <para>This sets the connection speed to
	115,200 <acronym>kbps</acronym>.</para>

      <screen>ppp ON example&gt; <userinput>enable dns</userinput></screen>

      <para>This tells <command>ppp</command> to configure the
	resolver and add the nameserver lines to
	<filename>/etc/resolv.conf</filename>.  If
	<command>ppp</command> cannot determine the hostname, it can
	manually be set later.</para>

      <screen>ppp ON example&gt; <userinput>term</userinput></screen>

      <para>This switches to <quote>terminal</quote> mode in order to
	manually control the modem.</para>

      <programlisting>deflink: Entering terminal mode on <filename class="devicefile">/dev/cuau1</filename>
type '~h' for help</programlisting>

      <screen><userinput>at</userinput>
OK
<userinput>atdt<replaceable>123456789</replaceable></userinput></screen>

      <para>Use <command>at</command> to initialize the modem, then
	use <command>atdt</command> and the number for the
	<acronym>ISP</acronym> to begin the dial in process.</para>

      <screen>CONNECT</screen>

      <para>Confirmation of the connection, if we are going to have
	any connection problems, unrelated to hardware, here is where
	we will attempt to resolve them.</para>

      <screen>ISP Login:<userinput>myusername</userinput></screen>

      <para>At this prompt, return the prompt with the username that
	was provided by the <acronym>ISP</acronym>.</para>

      <screen>ISP Pass:<userinput>mypassword</userinput></screen>

      <para>At this prompt, reply with the password that was provided
	by the <acronym>ISP</acronym>.  Just like logging into &os;,
	the password will not echo.</para>

      <screen>Shell or PPP:<userinput>ppp</userinput></screen>

      <para>Depending on the <acronym>ISP</acronym>, this prompt
	might not appear.  If it does, it is asking whether to use a
	shell on the provider or to start
	<command>ppp</command>.  In this example,
	<command>ppp</command> was selected in order to establish an
	Internet connection.</para>

      <screen>Ppp ON example&gt;</screen>

      <para>Notice that in this example the first <option>p</option>
	has been capitalized.  This shows that we have successfully
	connected to the <acronym>ISP</acronym>.</para>

      <screen>PPp ON example&gt;</screen>

      <para>We have successfully authenticated with our
	<acronym>ISP</acronym> and are waiting for the assigned
	<acronym>IP</acronym> address.</para>

      <screen>PPP ON example&gt;</screen>

      <para>We have made an agreement on an <acronym>IP</acronym>
	address and successfully completed our connection.</para>

      <screen>PPP ON example&gt;<userinput>add default HISADDR</userinput></screen>

      <para>Here we add our default route, we need to do this before
	we can talk to the outside world as currently the only
	established connection is with the peer.  If this fails due to
	existing routes, put a bang character
	<literal>!</literal> in front of the <option>add</option>.
	Alternatively, set this before making the actual
	connection and it will negotiate a new route
	accordingly.</para>

      <para>If everything went good we should now have an active
	connection to the Internet, which could be thrown into the
	background using <keycombo
	  action="simul"><keycap>CTRL</keycap>
	  <keycap>z</keycap></keycombo> If <command>PPP</command>
	returns to <command>ppp</command> then the connection has bee
	lost.  This is good to know because it shows the connection
	status.  Capital P's represent a connection to the
	<acronym>ISP</acronym> and lowercase p's show that the
	connection has been lost.</para>
      </sect2>

      <sect2>
	<title>Debugging</title>

	<para>If a connection cannot be established, turn hardware
	  flow <acronym>CTS/RTS</acronym> to off using <option>set
	    ctsrts off</option>.  This is mainly the case when
	  connected to some <application>PPP</application>-capable
	  terminal servers, where <application>PPP</application> hangs
	  when it tries to write data to the communication link, and
	  waits for a Clear To Send (<acronym>CTS</acronym>) signal
	  which may never come.  When using this option, include
	  <option>set accmap</option> as it may be required to defeat
	  hardware dependent on passing certain characters from end to
	  end, most of the time XON/XOFF.  Refer to &man.ppp.8; for
	  more information on this option and how it is used.</para>

	<para>An older modem may need <option>set parity
	    even</option>.  Parity is set at none be default, but is
	  used for error checking with a large increase in traffic,
	  on older modems.</para>

	<para><application>PPP</application> may not return to the
	  command mode, which is usually a negotiation error where the
	  <acronym>ISP</acronym> is waiting for negotiating to begin.
	  At this point, using  <command>~p</command> will force ppp
	  to start sending the configuration information.</para>

	<para>If a login prompt never appears, <acronym>PAP</acronym>
	  or <acronym>CHAP</acronym> authentication is most likely
	  required.  To use <acronym>PAP</acronym> or
	  <acronym>CHAP</acronym>, add the following options to
	  <application>PPP</application> before going into terminal
	  mode:</para>

	<screen>ppp ON example&gt; <userinput>set authname <replaceable>myusername</replaceable></userinput></screen>

	<para>Where <replaceable>myusername</replaceable> should be
	  replaced with the username that was assigned by the
	  <acronym>ISP</acronym>.</para>

	<screen>ppp ON example&gt; <userinput>set authkey <replaceable>mypassword</replaceable></userinput></screen>

	<para>Where <replaceable>mypassword</replaceable> should be
	  replaced with the password that was assigned by the
	  <acronym>ISP</acronym>.</para>

	<para>If a connection is established, but cannot seem to find
	  any domain name,  try to &man.ping.8; an
	  <acronym>IP</acronym> address.  If there is 100 percent
	  (100%) packet loss, it is likely that a default route was
	  not assigned.  Double check that <option>add default
	    HISADDR</option> was set during the connection.  If a
	  connection can be made to a remote <acronym>IP</acronym>
	  address, it is possible that a resolver address has not been
	  added to <filename>/etc/resolv.conf</filename>.  This file
	  should look like:</para>

	<programlisting>domain <replaceable>example.com</replaceable>
nameserver <replaceable>x.x.x.x</replaceable>
nameserver <replaceable>y.y.y.y</replaceable></programlisting>

	<para>Where <replaceable>x.x.x.x</replaceable> and
	  <replaceable>y.y.y.y</replaceable> should be replaced with
	  the <acronym>IP</acronym> address of the
	  <acronym>ISP</acronym>'s DNS servers.</para>

	<para>To configure &man.syslog.3; to provide logging for the
	  <application>PPP</application> connection, make sure this
	  line exists in <filename>/etc/syslog.conf</filename>:</para>

	<programlisting>!ppp
*.*     /var/log/ppp.log</programlisting>

    </sect2>
  </sect1>

  <sect1 xml:id="pppoe">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Jim</firstname>
	  <surname>Mock</surname>
	  <contrib>Contributed (from
	    http://node.to/freebsd/how-tos/how-to-freebsd-pppoe.html)
	    by in Jan 2000</contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>Using <acronym>PPP</acronym> over Ethernet (PPPoE)</title>

    <indexterm>
      <primary><acronym>PPP</acronym></primary>
      <secondary>over Ethernet</secondary>
    </indexterm>

    <para>This section describes how to set up <acronym>PPP</acronym>
      over Ethernet (<acronym>PPPoE</acronym>).</para>

    <para>Here is an example of a working
      <filename>ppp.conf</filename>:</para>

    <programlisting>default:
  set log Phase tun command # you can add more detailed logging if you wish
  set ifaddr 10.0.0.1/0 10.0.0.2/0

name_of_service_provider:
  set device PPPoE:<replaceable>xl1</replaceable> # replace xl1 with your Ethernet device
  set authname YOURLOGINNAME
  set authkey YOURPASSWORD
  set dial
  set login
  add default HISADDR</programlisting>

      <para>As <systemitem class="username">root</systemitem>,
	run:</para>

      <screen>&prompt.root; <userinput>ppp -ddial name_of_service_provider</userinput></screen>

      <para>Add the following to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting>ppp_enable="YES"
ppp_mode="ddial"
ppp_nat="YES"	# if you want to enable nat for your local network, otherwise NO
ppp_profile="name_of_service_provider"</programlisting>

    <sect2>
      <title>Using a PPPoE Service Tag</title>

      <para>Sometimes it will be necessary to use a service tag to
	establish the connection.  Service tags are used to
	distinguish between different PPPoE servers attached to a
	given network.</para>

      <para>Any required service tag information should be in the
	documentation provided by the <acronym>ISP</acronym>.</para>

      <para>As a last resort, one could try installing the
	<package>net/rr-pppoe</package> package or port.  Bear in mind
	however, this may de-program your modem and render it useless,
	so think twice before doing it.  Simply install the program
	shipped with the modem.  Then, access the
	<guimenu>System</guimenu> menu from the program.  The name of
	the profile should be listed there.  It is usually
	<emphasis>ISP</emphasis>.</para>

      <para>The profile name (service tag) will be used in the PPPoE
	configuration entry in <filename>ppp.conf</filename> as the
	provider part for <command>set device</command>.  Refer to
	&man.ppp.8; for full details.  It should look like
	this:</para>

      <programlisting>set device PPPoE:<replaceable>xl1</replaceable>:<replaceable>ISP</replaceable></programlisting>

      <para>Do not forget to change <replaceable>xl1</replaceable> to
	the proper device for the Ethernet card.</para>

      <para>Do not forget to change <replaceable>ISP</replaceable> to
	the profile.</para>

      <para>For additional information, refer to <link
	  xlink:href="http://renaud.waldura.com/doc/freebsd/pppoe/">Cheaper
	  Broadband with &os; on DSL</link> by Renaud Waldura.</para>
    </sect2>

    <sect2 xml:id="ppp-3com">

      <title>PPPoE with a &tm.3com;
	<trademark class="registered">HomeConnect</trademark> ADSL
	Modem Dual Link</title>

      <para>This modem does not follow the PPPoE specification defined
	in <link
	  xlink:href="http://www.faqs.org/rfcs/rfc2516.html">RFC
	  2516</link>.</para>

      <para>In order to make &os; capable of communicating with this
	device, a sysctl must be set.  This can be done automatically
	at boot time by updating
	<filename>/etc/sysctl.conf</filename>:</para>

	<programlisting>net.graph.nonstandard_pppoe=1</programlisting>

      <para>or can be done immediately with the command:</para>

      <screen>&prompt.root; <userinput>sysctl net.graph.nonstandard_pppoe=1</userinput></screen>

      <para>Unfortunately, because this is a system-wide setting, it
	is not possible to talk to a normal PPPoE client or server and
	a &tm.3com; <trademark
	  class="registered">HomeConnect</trademark> ADSL Modem at the
	same time.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="pppoa">
    <title>Using <application>PPP</application> over
      <acronym>ATM</acronym> (PPPoA)</title>

    <indexterm>
      <primary><acronym>PPP</acronym></primary>
      <secondary>over <acronym>ATM</acronym></secondary>
    </indexterm>

    <indexterm>
      <primary>PPPoA</primary>
    </indexterm>

    <para>The following describes how to set up PPP over
      <acronym>ATM</acronym> (PPPoA).  PPPoA is a popular choice among
      European DSL providers.</para>
<!--
This port is broken as of June, 2009
    <sect2>
      <title>Using PPPoA with the Alcatel &speedtouch; USB</title>

      <para>PPPoA support for this device is supplied as a port in
	&os; because the firmware is distributed under <ulink
	url="http://www.speedtouchdsl.com/disclaimer_lx.htm">Alcatel's
	license agreement</ulink> and can not be redistributed freely
	with the base system of &os;.</para>

      <para>This software can be installed using the
	<filename role="package">net/pppoa</filename> package or port.  Once installed, follow
	the instructions provided with it.</para>

      <para>Like many USB devices, the Alcatel &speedtouch; USB needs
	to download firmware from the host computer to operate
	properly.  It is possible to automate this process in &os;
	so that this transfer takes place whenever the device is
	plugged into a USB port.  The following information can be
	added to the <filename>/etc/usbd.conf</filename> file to
	enable this automatic firmware transfer.  This file must be
	edited as the <username>root</username> user.</para>

      <programlisting>device "Alcatel SpeedTouch USB"
    devname "ugen[0-9]+"
    vendor 0x06b9
    product 0x4061
    attach "/usr/local/sbin/modem_run -f /usr/local/libdata/mgmt.o"</programlisting>

      <para>To enable the USB daemon, <application>usbd</application>,
	put the following the line into
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting>usbd_enable="YES"</programlisting>

      <para>It is also possible to set up
	<application>ppp</application> to dial up at startup.  To do
	this add the following lines to
	<filename>/etc/rc.conf</filename>.  Again, for this procedure
	you will need to be logged in as the <username>root</username>
	user.</para>

      <programlisting>ppp_enable="YES"
ppp_mode="ddial"
ppp_profile="adsl"</programlisting>

      <para>For this to work correctly you will need to have used the
	sample <filename>ppp.conf</filename> which is supplied with
	the <filename role="package">net/pppoa</filename> port.</para>
    </sect2>
    -->

    <sect2>
      <title>Using mpd</title>

      <para>The <application>mpd</application> application can be used
	to connect to a variety of services, in particular PPTP
	services.  It can be installed using the
	<package>net/mpd5</package> package or port.  Many ADSL modems
	require that a PPTP tunnel is created between the modem and
	computer.</para>

      <para>Once installed, configure <application>mpd</application>
	to suit the provider's settings.  The port places a set of
	sample configuration files which are well documented in
	<filename>/usr/local/etc/mpd/</filename>.  A complete guide to
	configure <application>mpd</application> is available in HTML
	format in <filename>/usr/ports/share/doc/mpd/</filename>.
	Here is a sample configuration for connecting to an ADSL
	service with <application>mpd</application>.  The
	configuration is spread over two files, first the
	<filename>mpd.conf</filename>:</para>

      <note>
	<para>This example <filename>mpd.conf</filename> only works
	  with <application>mpd</application> 4.x.</para>
      </note>

      <programlisting>default:
    load adsl

adsl:
    new -i ng0 adsl adsl
    set bundle authname <replaceable>username</replaceable> <co xml:id="co-mpd-ex-user"/>
    set bundle password <replaceable>password</replaceable> <co xml:id="co-mpd-ex-pass"/>
    set bundle disable multilink

    set link no pap acfcomp protocomp
    set link disable chap
    set link accept chap
    set link keep-alive 30 10

    set ipcp no vjcomp
    set ipcp ranges 0.0.0.0/0 0.0.0.0/0

    set iface route default
    set iface disable on-demand
    set iface enable proxy-arp
    set iface idle 0

    open</programlisting>

    <calloutlist>
      <callout arearefs="co-mpd-ex-user">
	<para>The username used to authenticate with your
	  <acronym>ISP</acronym>.</para>
      </callout>
      <callout arearefs="co-mpd-ex-pass">
	<para>The password used to authenticate with your
	  <acronym>ISP</acronym>.</para>
      </callout>
    </calloutlist>

    <para>Information about the link, or links, to establish is found
      in <filename>mpd.links</filename>.  An example
      <filename>mpd.links</filename> to accompany the above example
      is given beneath:</para>

    <programlisting>adsl:
    set link type pptp
    set pptp mode active
    set pptp enable originate outcall
    set pptp self <replaceable>10.0.0.1</replaceable> <co xml:id="co-mpd-ex-self"/>
    set pptp peer <replaceable>10.0.0.138</replaceable> <co xml:id="co-mpd-ex-peer"/></programlisting>

    <calloutlist>
      <callout arearefs="co-mpd-ex-self">
	<para>The <acronym>IP</acronym> address of &os; computer
	  running <application>mpd</application>.</para>
      </callout>
      <callout arearefs="co-mpd-ex-peer">
	<para>The <acronym>IP</acronym> address of the ADSL modem.
	  The Alcatel &speedtouch; Home defaults to <systemitem
	    class="ipaddress">10.0.0.138</systemitem>.</para>
      </callout>
    </calloutlist>

    <para>It is possible to initialize the connection easily by
      issuing the following command as
      <systemitem class="username">root</systemitem>:</para>

    <screen>&prompt.root; <userinput>mpd -b <replaceable>adsl</replaceable></userinput></screen>

    <para>To view the status of the connection:</para>

    <screen>&prompt.user; <userinput>ifconfig <replaceable>ng0</replaceable></userinput>
ng0: flags=88d1&lt;UP,POINTOPOINT,RUNNING,NOARP,SIMPLEX,MULTICAST&gt; mtu 1500
     inet 216.136.204.117 --&gt; 204.152.186.171 netmask 0xffffffff</screen>

    <para>Using <application>mpd</application> is the recommended
      way to connect to an ADSL service with &os;.</para>
  </sect2>

  <sect2>
    <title>Using pptpclient</title>

    <para>It is also possible to use &os; to connect to other
      PPPoA services using <package>net/pptpclient</package>.</para>

    <para>To use <package>net/pptpclient</package>
      to connect to a DSL service, install the port or package, then
      edit <filename>/etc/ppp/ppp.conf</filename>.  An example section
      of <filename>ppp.conf</filename> is given below.  For further
      information on <filename>ppp.conf</filename> options consult
      &man.ppp.8;.</para>

    <programlisting>adsl:
 set log phase chat lcp ipcp ccp tun command
 set timeout 0
 enable dns
 set authname <replaceable>username</replaceable> <co xml:id="co-pptp-ex-user"/>
 set authkey <replaceable>password</replaceable> <co xml:id="co-pptp-ex-pass"/>
 set ifaddr 0 0
 add default HISADDR</programlisting>

    <calloutlist>
      <callout arearefs="co-pptp-ex-user">
	<para>The username for the DSL provider.</para>
      </callout>

      <callout arearefs="co-pptp-ex-pass">
	<para>The password for your account.</para>
      </callout>
    </calloutlist>

    <warning>
      <para>Since the account's password is added to
	<filename>ppp.conf</filename>in plain text form, make sure
	nobody can read the contents of this file:</para>

      <screen>&prompt.root; <userinput>chown root:wheel /etc/ppp/ppp.conf</userinput>
&prompt.root; <userinput>chmod 600 /etc/ppp/ppp.conf</userinput></screen>

      </warning>

      <para>This will open a tunnel for a <acronym>PPP</acronym>
	session to the DSL router.  Ethernet DSL modems have a
	preconfigured LAN <acronym>IP</acronym> address to connect to.
	In the case of the Alcatel &speedtouch; Home, this address is
	<systemitem class="ipaddress">10.0.0.138</systemitem>.  The
	router's documentation should list the address the device
	uses.  To open the tunnel and start a <acronym>PPP</acronym>
	session:</para>

      <screen>&prompt.root; <userinput>pptp <replaceable>address</replaceable> <replaceable>adsl</replaceable></userinput></screen>

      <tip>
	<para>If an ampersand (<quote>&amp;</quote>) is added
	  to the end of this command,
	  <application>pptp</application> will return the
	  prompt.</para>
      </tip>

      <para>A <filename>tun</filename> virtual tunnel device
	will be created for interaction between the
	<application>pptp</application> and
	<application>ppp</application> processes.  Once the
	prompt is returned, or the
	<application>pptp</application> process has confirmed a
	connection, examine the tunnel:</para>

      <screen>&prompt.user; <userinput>ifconfig <replaceable>tun0</replaceable></userinput>
tun0: flags=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1500
        inet 216.136.204.21 --&gt; 204.152.186.171 netmask 0xffffff00
	Opened by PID 918</screen>

      <para>If the connection fails, check the configuration of
	the router, which is usually accessible using
	a web browser.  Also, examine the output of
	<command>pptp</command> and the contents of the
	log file,
	<filename>/var/log/ppp.log</filename> for clues.</para>
    </sect2>
  </sect1>
</chapter>
